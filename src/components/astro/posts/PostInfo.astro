---
import { Icon } from "@/components/react/Icon";
import { formatDate } from "@/lib/date";
import type { CollectionEntry } from "astro:content";
import PostInfoTag from "./PostInfoTag.astro";

interface Props {
  post: CollectionEntry<"posts">;
  readingTime: string;
}

const { post, readingTime } = Astro.props;
---

<div class="mx-auto flex w-full flex-col items-start justify-center gap-2">
  <PostInfoTag id="views-badge" data-slug={post.slug} className="fluent--eye-lines-20-regular">
    <span id="views-count" class="text-xl font-bold"></span>
    <span> views</span>
  </PostInfoTag>

  <PostInfoTag className="fluent--calendar-20-regular">
    Published at: <b>{formatDate(post.data.date)}</b>
  </PostInfoTag>

  <PostInfoTag id="views-badge" data-slug={post.slug} className="fluent--reading-list-20-regular">
    Reading time: <b>{readingTime}</b>
  </PostInfoTag>
</div>

<script>
  import { postsApi } from "@/lib/api";

  function main() {
    const badge = document.querySelector("#views-badge") as HTMLElement;
    const count = document.querySelector("#views-count");

    if (!count || !badge) return;

    badge.dataset.loading = "true";

    const slug = badge.dataset.slug!;

    postsApi
      .getPost(slug)
      .then(({ post }) => {
        count.textContent = String(post.views);

        const cat = document.getElementById("cat-count") as HTMLElement | undefined;
        if (!cat) return;
        cat.textContent = String(post.likes);
      })
      .finally(() => {
        badge.dataset.loading = "false";
      })
      .catch(() => {
        count.textContent = "0";
      });
  }

  main();
</script>
