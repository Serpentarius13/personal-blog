---
import type { MarkdownHeading } from "astro";
import TocItem from "./TocItem.astro";
import { cn } from "@/lib/cn";
import { type TocHeading } from "./toc.types";
import { custom } from "astro:schema";

interface Props {
  headings: MarkdownHeading[];
  class?: string;
}

const { headings, class: className } = Astro.props;

function buildToc(headings: MarkdownHeading[]): TocHeading[] {
  const toc: TocHeading[] = [];
  const stack: TocHeading[] = [];

  headings.forEach((h) => {
    const heading = { ...h, children: [] } satisfies TocHeading;

    while (stack.length > 0 && stack[stack.length - 1].depth >= heading.depth) {
      stack.pop();
    }

    if (stack.length === 0) {
      toc.push(heading);
    } else {
      stack[stack.length - 1].children?.push(heading);
    }

    stack.push(heading);
  });

  return toc;
}

const toc = buildToc(headings.filter((h) => h.depth !== 1));
---

<aside
  class={cn(
    "p-2 shadow-md shadow-primary max-w-xs rounded-lg bg-base-100 backdrop-blur-xl z-[10]",
    className,
  )}
  id="toc"
>
  <ul class="menu menu-xs w-full max-h-[400px] overflow-auto flex-nowrap">
    {toc.map((heading, index) => <TocItem heading={heading} index={index} />)}
  </ul>
</aside>

<script is:inline>
  var isTocEnabled = false;

  var setupToc = () => {
    if (isTocEnabled) return;

    if (!window.matchMedia("(min-width: 1024px)").matches) return;

    const links = document.querySelectorAll("#toc a[href^='#']");

    for (const link of links) {
      link.addEventListener("click", (event) => {
        event.preventDefault();
        const target = document.querySelector(link.getAttribute("href"));
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    }

    const header = document.querySelector("header");
    const headerHeight = header ? header.offsetHeight : 0;

    const observer = new IntersectionObserver(
      (sections) => {
        sections.forEach((section) => {
          const heading = section.target.querySelector("h2, h3, h4, h5, h6");
          if (!heading) return;

          const id = heading.getAttribute("id");
          const link = document.querySelector(`#toc li a[href="#${id}"]`);
          if (!link) return;

          const addRemove = section.isIntersecting ? "add" : "remove";
          link.classList[addRemove]("seeing");
        });
      },
      {
        rootMargin: `-${headerHeight}px 0px 0px 0px`,
      },
    );

    const sections = document.querySelectorAll(".prose section");
    sections.forEach((section) => {
      observer.observe(section);
    });

    isTocEnabled = true;
  };

  document.addEventListener("astro:page-load", setupToc);

  document.addEventListener("astro:after-swap", setupToc);

  var setupTocResizeObserver = () => {
    function debounce(func, ms) {
      let timeout;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, arguments), ms);
      };
    }

    const checkToc = debounce(() => {
      if (isTocEnabled) return;

      setupToc();
    }, 300);

    setTimeout(() => {
      const resizeObserver = new ResizeObserver((entries) => {
        const entry = entries[0];
        if (entry && entry.contentRect.width >= 1024) {
          checkToc();
        }
      });

      resizeObserver.observe(document.body);
    }, 1000);
  };

  document.addEventListener("astro:page-load", setupTocResizeObserver);
  document.addEventListener("astro:before-swap", () => {
    isTocEnabled = false;
  });
  document.addEventListener("astro:after-swap", setupTocResizeObserver);
</script>
